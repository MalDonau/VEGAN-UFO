<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vegan UFO</title>
  <style>
    :root {
      --c-celeste: #87CEEB;
      --c-azul-oscuro: #010A1A;
      --beam-color: 255, 255, 210;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;display:grid;place-items:center;background:#000;font-family:system-ui, sans-serif}

    .frame{width:920px;aspect-ratio:16/9;position:relative;overflow:hidden;border-radius:8px;box-shadow:0 0 0 1px rgba(255,255,255,.08),0 10px 30px rgba(0,0,0,.6);background:linear-gradient(to top,var(--c-celeste),var(--c-azul-oscuro));touch-action:none}

    .world{position:absolute;inset:0;height:100%;width:2760px;will-change:transform;pointer-events:none}
    .section{position:absolute;top:0;bottom:0;width:920px;pointer-events:none}
    .granja{left:0}
    .pinar{left:920px}
    .prado{left:1840px}

    /* Transición marrón→verde en el PINAR (de izquierda a derecha) */
    .pinar::before{content:"";position:absolute;left:0;right:0;top:80%;bottom:0;pointer-events:none;z-index:1;
      /* Capa 1: verde que aumenta hacia la derecha */
      background:
        linear-gradient(to right, rgba(42,143,58,0) 0%, rgba(42,143,58,.5) 65%, rgba(42,143,58,.85) 100%),
        /* Capa 2: leve sombreado vertical para emparentar con el prado */
        linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,.12) 100%);
    }

    /* Suelo verde en el prado */
    .prado::before{content:"";position:absolute;left:0;right:0;top:80%;bottom:0;background:linear-gradient(to bottom,#2a8f3a 0%, #206e2e 100%);z-index:1;pointer-events:none}


    .ground{position:absolute;left:0;right:0;top:80%;bottom:0;background:linear-gradient(to bottom,#5a3b1f,#2c1a0f);z-index:0}
    .tree{position:absolute;width:0;height:0;pointer-events:none;z-index:2;border-left-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-color:transparent;border-right-color:transparent;border-bottom-color:#1e5f39}
    .tree.shadow::after{content:"";position:absolute;left:-50%;right:-50%;bottom:-2px;height:4px;background:radial-gradient(closest-side,rgba(0,0,0,.35),rgba(0,0,0,0));filter:blur(1px)}

    /* Cielo estrellado */
    .stars{position:absolute;left:0;top:0;width:2760px;height:62%;pointer-events:none;z-index:0}
    .stars .star{position:absolute;border-radius:50%;background:radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,.85) 40%, rgba(255,255,255,0) 70%);opacity:.7;filter:drop-shadow(0 0 2px rgba(255,255,255,.6));animation:twinkle var(--tw-dur,3s) ease-in-out infinite}
    @keyframes twinkle{0%,100%{opacity:.35}50%{opacity:1}}

    .ufo{position:absolute;width:120px;height:60px;pointer-events:none;z-index:5;transform-origin:50% 60%}
    /* UFO estilizado tipo cartoon */
    .ufo-dome{position:absolute;left:50%;top:-2px;transform:translateX(-50%);width:78px;height:38px;border-radius:50% 50% 45% 45%/60% 60% 40% 40%;
      background:
        radial-gradient(120px 60px at 60% 20%, rgba(255,255,255,.9) 0 10%, rgba(210,235,255,.85) 11% 30%, rgba(140,190,230,.7) 31% 90%, rgba(120,170,210,.55) 91% 100%);
      border:3px solid rgba(220,240,255,.85);
      box-shadow: inset 0 -6px 10px rgba(0,0,0,.18), 0 2px 0 rgba(0,0,0,.25);
    }
    .ufo-disc{position:absolute;left:50%;top:22px;transform:translateX(-50%);width:120px;height:36px;border-radius:50%/60%;
      background:
        radial-gradient(140px 60px at 50% 35%, #53677d 0%, #3b4e63 55%, #263243 100%),
        repeating-radial-gradient(circle at 40% 60%, rgba(0,0,0,.22) 0 1px, transparent 1px 6px);
      border:4px solid #111b29; box-shadow:inset 0 2px 5px rgba(255,255,255,.18), inset 0 -4px 6px rgba(0,0,0,.45), 0 6px 10px rgba(0,0,0,.35);
    }
    .ufo-base{position:absolute;left:50%;top:44px;transform:translateX(-50%);width:86px;height:14px;border-radius:50%/60%;
      background:radial-gradient(80px 30px at 50% 30%, #1d2430 0%, #0f141e 100%);
      box-shadow:inset 0 2px 3px rgba(255,255,255,.06), 0 6px 10px rgba(0,0,0,.45);
    }
    .ufo-light{position:absolute;top:30px;width:18px;height:18px;border-radius:50%;
      background:radial-gradient(ellipse at 40% 35%, #ffe9a6 0%, #ffd36a 55%, #f4a93e 80%, #a0621f 100%);
      border:3px solid #0e1420; box-shadow:0 2px 0 rgba(0,0,0,.35), 0 0 8px rgba(255,214,110,.45);
    }
    .ufo-light.l1{left:16px}
    .ufo-light.l2{left:51px}
    .ufo-light.l3{left:86px}
    .beam{position:absolute;width:100px;height:0;left:0;top:0;display:none;pointer-events:none;clip-path:polygon(35% 0%,65% 0%,100% 100%,0% 100%);background:linear-gradient(to bottom,rgba(var(--beam-color),.3) 0%, rgba(var(--beam-color),.6) 50%, rgba(var(--beam-color),0) 100%);filter:blur(.5px);transform-origin:50% 0%;z-index:4}
    .box{position:absolute;width:30px;height:20px;background:#fff;z-index:3}

    /* Vaquitas (estilo simple) */
    .cow{background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:5px 7px 5px 5px / 6px 8px 6px 6px;box-shadow:inset 0 -2px 0 rgba(0,0,0,.12);
      background-image:
        radial-gradient(6px 5px at 65% 45%, #000 60%, transparent 61%),
        radial-gradient(5px 4px at 40% 75%, #000 60%, transparent 61%);
      background-repeat:no-repeat;}
    .cow .head{position:absolute;right:-10px;top:2px;width:14px;height:10px;background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:2px;} 
    .cow .head::before{content:"";position:absolute;left:3px;top:3px;width:2px;height:2px;background:#000;border-radius:1px;box-shadow:5px 0 0 #000;}
    .cow .ear{position:absolute;top:-3px;width:4px;height:4px;background:#fff;border:1px solid rgba(0,0,0,.15);border-bottom:none;border-radius:2px 2px 0 0}
    .cow .ear.left{left:1px}
    .cow .ear.right{right:1px}
    .cow .leg{position:absolute;bottom:-2px;width:3px;height:6px;background:#111;border-radius:0 0 2px 2px}
    .cow .leg.left{left:6px}
    .cow .leg.right{left:18px}
    .cow .tail{position:absolute;left:-5px;top:5px;width:6px;height:2px;background:#111;border-radius:2px;transform-origin:100% 50%;animation:tail 1.2s ease-in-out infinite;opacity:.9}
    @keyframes tail{0%{transform:rotate(12deg)}50%{transform:rotate(-8deg)}100%{transform:rotate(12deg)}}

    .hud{position:absolute;top:10px;right:10px;display:flex;gap:8px;background:rgba(0,0,0,.35);color:#fff;padding:6px 10px;border-radius:6px;font-weight:600;z-index:11}
    .hud span{min-width:58px;text-align:center}
    .hud .pauseBtn{border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.45);color:#fff;border-radius:6px;padding:4px 8px;cursor:pointer;font-weight:700;line-height:1;min-width:auto}
    .hud .pauseBtn[aria-pressed="true"]{background:rgba(255,255,255,.15);}

    .intro{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:20;background:rgba(0,0,0,.45)}
    .intro .panel{max-width:72%;color:#fff;text-align:center;background:rgba(0,0,0,.35);padding:16px 20px;border-radius:12px;border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .intro .panel p{margin:0 0 6px;font-weight:600;font-size:18px}
    .intro .panel .hint{opacity:.85;font-size:12px}
    .intro .panel .sub{opacity:.9;font-size:12px;margin-top:2px;margin-bottom:6px}

    /* Animación de carteles */
    @keyframes popIn{0%{transform:scale(.92);opacity:0}60%{transform:scale(1.02);opacity:1}100%{transform:scale(1);opacity:1}}
    .pop{animation:popIn 240ms cubic-bezier(.22,1,.36,1) forwards}
    .intro .panel, .intro .panel .sub, .intro .panel .hint{transform:scale(.96);opacity:0;will-change:transform,opacity}
    .intro .panel .sub.pop{animation-delay:80ms}
    .intro .panel .hint.pop{animation-delay:130ms}

    /* Cartel de Game Over */
    .gameover{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:24;background:rgba(0,0,0,.55)}
    .gameover .panel{max-width:72%;color:#fff;text-align:center;background:rgba(0,0,0,.35);padding:16px 20px;border-radius:12px;border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .gameover .panel .l1{margin:0 0 4px;font-weight:800;font-size:22px}
    .gameover .panel .l2{margin:0;font-weight:700;font-size:18px;opacity:.9}
    .gameover .panel{transform:scale(.96);opacity:0;animation:popIn 220ms cubic-bezier(.22,1,.36,1) forwards}


    /* Camión transportador (simple) */
    .truck{position:absolute;width:170px;height:72px;z-index:2;pointer-events:none}
    .truck .body{position:absolute;left:36px;bottom:22px;width:120px;height:38px;background:#4a6fa1;border:1px solid rgba(0,0,0,.35);border-radius:4px;box-shadow:inset 0 -2px 0 rgba(0,0,0,.2)}
    .truck .cab{position:absolute;left:0;bottom:22px;width:44px;height:30px;background:#6f90c0;border:1px solid rgba(0,0,0,.35);border-radius:3px 3px 2px 2px}
    .truck .cab::after{content:"";position:absolute;left:6px;top:4px;width:24px;height:12px;background:linear-gradient(to bottom,#d8ecff,#9dc0e8);border-radius:2px}
    .truck .wheel{position:absolute;bottom:0;width:16px;height:16px;background:#111;border-radius:50%;box-shadow:inset 0 0 0 3px #333}
    .truck .wheel.w1{left:44px}
    .truck .wheel.w2{left:112px}
    .truck .ramp{position:absolute;left:150px;bottom:24px;width:80px;height:10px;background:linear-gradient(to right,#7aa35a,#5e8b46);border:1px solid rgba(0,0,0,.25);border-left:none;border-radius:0 2px 2px 0;transform-origin:left center;transform:rotate(16deg)}
    .truck .grill{position:absolute;left:2px;bottom:14px;width:4px;height:24px;background:rgba(0,0,0,.25);border-radius:2px}

    .unmute{position:absolute;top:10px;left:10px;z-index:21;background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.25);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;display:none}
    /* Título inicial */
    .titleOverlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:25;color:#fff;font-size:48px;font-weight:800;letter-spacing:.5px;text-shadow:0 2px 10px rgba(0,0,0,.6);background:radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0) 60%)}
</style>
</head>
<body>
  <main class="frame" id="frame">
    <div class="world" id="world">
      <div class="section granja" id="granja"></div>
      <div class="section pinar" id="pinar"></div>
      <div class="section prado" id="prado"></div>
      <div class="stars" id="stars"></div>
      <div class="ground"></div>
      <div class="beam" id="beam"></div>
      <div class="ufo" id="ufo">
        <div class="ufo-base"></div>
        <div class="ufo-disc"></div>
        <div class="ufo-dome"></div>
        <div class="ufo-light l1"></div>
        <div class="ufo-light l2"></div>
        <div class="ufo-light l3"></div>
      </div>
      <div id="herd"></div>
    </div>

    <div class="hud"><span id="hudTimer">40.0</span><span id="hudGoal">0/4</span><span id="hudLevel">Lv 1</span><button id="btnPause" class="pauseBtn" aria-pressed="false" title="Pausa (P)">⏸</button></div>
    <div id="intro" class="intro"><div class="panel"><p id="introMain"></p><p id="introSub" class="sub"></p><div class="hint">Clic para comenzar</div></div></div>
    <div id="gameover" class="gameover"><div class="panel"><p class="l1">¡Ay, las pobres vaquitas!</p><p class="l2">game over</p></div></div>
    <button id="unmute" class="unmute" aria-label="Activar sonido">🔊 Activar sonido</button>
      <div id="titleOverlay" class="titleOverlay">Vegan UFO</div>
  </main>

  <script>
  // ==== Constantes de mundo
  const VIEW_W = 920, VIEW_H = Math.round(920 * 9 / 16);
  const SECTION_W = 920, WORLD_W = 2760, MAX_CAM = WORLD_W - VIEW_W;
  const SECTION_PRADO_START = 1840;
  const ROUND_TIME = 40; // s

  // ==== DOM
  const frame = document.getElementById('frame');
  const world = document.getElementById('world');
  const ufo = document.getElementById('ufo');
  const beam = document.getElementById('beam');
  const herdEl = document.getElementById('herd');
  const elTimer = document.getElementById('hudTimer');
  const elGoal = document.getElementById('hudGoal');
  const elLevel = document.getElementById('hudLevel');
  const pinarEl = document.getElementById('pinar');
  const pradoEl = document.getElementById('prado');
  const starsEl = document.getElementById('stars');
  const elIntro = document.getElementById('intro');
  const introMain = document.getElementById('introMain');
  const introSub = document.getElementById('introSub');
  const unmuteBtn = document.getElementById('unmute');
  const btnPause = document.getElementById('btnPause');
  const titleEl = document.getElementById('titleOverlay');
  const gameOverEl = document.getElementById('gameover');

  // ==== Utilidades
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  function horizonY(){ return VIEW_H * 0.8; }
  function linearThenSmoothDecel(t, split=0.82){
    if (t <= split) return t;
    const u = (t - split) / (1 - split);
    const f = -u*u*u + u*u + u; // Hermite: f(0)=0, f'(0)=1, f(1)=1, f'(1)=0
    return split + (1 - split) * f;
  }

  // ==== Estado
  let UISCALE = 1;
  let mode = 'title'; // 'title' | 'cinematic' | 'game'
  const CINE_DUR = 4.0; let cineStart = null;
  const TITLE_DUR = 2.0; let titleStart = null;
  const GAMEOVER_DUR = 3.0; let gameOverStart = null;
  let phase = 'ready'; // 'ready' | 'running' | 'won' | 'lost'
  let herdCount = 4, deliveredCount = 0, round = 1;
  let timeLeft = ROUND_TIME, lastTs = null;
  let camX = MAX_CAM, camV = 0; // arrancamos mirando el PRADO
  let targetX = VIEW_W/2, targetY = 200;
  let currentX = MAX_CAM + VIEW_W + 140, currentY = 200; // OVNI fuera a la derecha
  let pointerLocalX = VIEW_W/2, pointerLocalY = 200;
  let idle=false, idleAngle=0; let beamOn=false; let isPointerDown=false;
  let capturedIndex = -1; let prevUfoX = currentX; let beamAngleDeg=0, ufoAngleDeg=0;
  let paused = false; let truckEl = null;

  // ==== Audio
  let audioCtx=null, masterGain=null, reverbNode=null, tone=null, theremin=null, thereminFaded=false;
  function makeReverbImpulse(ctx, seconds=2.0, decay=2.4){ const rate=ctx.sampleRate; const len=Math.max(1,Math.floor(seconds*rate)); const buf=ctx.createBuffer(2,len,rate); for(let ch=0; ch<2; ch++){ const d=buf.getChannelData(ch); for(let i=0;i<len;i++){ const t=i/len; d[i]=(Math.random()*2-1)*Math.pow(1-t,decay); } } return buf; }
  function ensureAudio(){
    if(!audioCtx){
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      masterGain=audioCtx.createGain();
      masterGain.gain.value=.35;
      masterGain.connect(audioCtx.destination);

      // Reverb global (RETURN único para evitar duplicaciones)
      reverbNode=audioCtx.createConvolver();
      reverbNode.buffer=makeReverbImpulse(audioCtx,1.4,2.0);
      // Filtro post-reverb para evitar acumulación de graves (anti-acople)
      if(!window.__postVerb){
        window.__postVerb = audioCtx.createBiquadFilter();
        window.__postVerb.type = 'highpass';
        window.__postVerb.frequency.value = 120;
        window.__reverbReturn = audioCtx.createGain();
        window.__reverbReturn.gain.value = 1.0;
        reverbNode.connect(window.__postVerb);
        window.__postVerb.connect(window.__reverbReturn);
        window.__reverbReturn.connect(masterGain);
      }
    }
    if(audioCtx.state==='suspended'){ try{audioCtx.resume();}catch(_){} }
    return !!audioCtx && audioCtx.state==='running';
  }
  // tono del haz (suave + acorde F + F grave + B)
  function startAbductTone(){
    ensureAudio(); if(!audioCtx) return;
    if(tone) return; // no reiniciar cada frame
    const now = audioCtx.currentTime;
    const F3 = 174.61, F2 = 87.31, B3 = 246.94;
    const env = audioCtx.createGain(); env.gain.setValueAtTime(0.0001, now); env.gain.linearRampToValueAtTime(0.45, now + 0.22);
    const filt = audioCtx.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=1400; filt.Q.value=0.7;
    const oFmid=audioCtx.createOscillator(); oFmid.type='triangle'; oFmid.frequency.value=F3; const gFmid=audioCtx.createGain(); gFmid.gain.value=0.55; oFmid.connect(gFmid); gFmid.connect(filt);
    const oFgrav=audioCtx.createOscillator(); oFgrav.type='sine'; oFgrav.frequency.value=F2; const gFgrav=audioCtx.createGain(); gFgrav.gain.value=0.5; oFgrav.connect(gFgrav); gFgrav.connect(filt);
    const oB=audioCtx.createOscillator(); oB.type='sine'; oB.frequency.value=B3; const gB=audioCtx.createGain(); gB.gain.value=0.35; oB.connect(gB); gB.connect(filt);
    const lfo=audioCtx.createOscillator(), lg=audioCtx.createGain(); lfo.type='sine'; lfo.frequency.value=4; lg.gain.value=5; lfo.connect(lg); lg.connect(oFmid.detune); lg.connect(oFgrav.detune); lg.connect(oB.detune);

    // Mezcla: seco y envío a reverb GLOBAL (sin conectar el convolver a múltiples "wet")
    const dry=audioCtx.createGain(); dry.gain.value=0.35;
    const send=audioCtx.createGain(); send.gain.value=0.30; // nivel de envío a reverb
    filt.connect(env);
    env.connect(dry); dry.connect(masterGain);
    env.connect(send); send.connect(reverbNode); // retorno único ya conectado al master

    const startT = now; oFmid.start(startT); oFgrav.start(startT); oB.start(startT); lfo.start(startT);
    tone = {oscillators:[oFmid, oFgrav, oB], lfo, env};
  }
  function stopAbductTone(fast=false){ if(!tone||!audioCtx) return; const t=tone; tone=null; const now=audioCtx.currentTime; const tail = fast ? 0.05 : 0.35; try{ t.env.gain.cancelScheduledValues(now); t.env.gain.setValueAtTime(Math.max(.0001,t.env.gain.value), now); t.env.gain.exponentialRampToValueAtTime(.0001, now+tail); (t.oscillators||[]).forEach(o=>{try{o.stop(now+tail+.05)}catch(_){}}); if(t.lfo){try{t.lfo.stop(now+tail+.05)}catch(_){}} }catch(_){} try{ (t.oscillators||[]).forEach(o=>{try{o.disconnect()}catch(_){}}); if(t.lfo&&t.lfo.disconnect) t.lfo.disconnect(); if(t.env&&t.env.disconnect) t.env.disconnect(); }catch(_){} }
  // cue triste (game over)
  function playSadCue(){ try{ ensureAudio(); if(!audioCtx) return; const ctx=audioCtx, now=ctx.currentTime; const o1=ctx.createOscillator(), o2=ctx.createOscillator(); o1.type='sine'; o2.type='triangle'; const g=ctx.createGain(); const send=ctx.createGain(); g.gain.value=.0; send.gain.value=.18; // leve reverb
    // Motivo descendente (menor): A4→F4→D4
    o1.frequency.setValueAtTime(440, now);
    o1.frequency.exponentialRampToValueAtTime(349.23, now+1.0);
    o1.frequency.exponentialRampToValueAtTime(293.66, now+2.4);
    o2.frequency.setValueAtTime(220, now);
    o2.frequency.exponentialRampToValueAtTime(174.61, now+2.4);
    // Envolvente suave de 2.6s
    g.gain.setValueAtTime(0.0001, now);
    g.gain.linearRampToValueAtTime(0.22, now+0.25);
    g.gain.linearRampToValueAtTime(0.0, now+2.6);
    o1.connect(g); o2.connect(g); g.connect(masterGain); g.connect(send); send.connect(reverbNode);
    o1.start(now); o2.start(now); o1.stop(now+2.7); o2.stop(now+2.7);
  }catch(_){} }

  // mugido
  function playMoo(kind='grab'){ try{ ensureAudio(); if(!audioCtx) return; const ctx=audioCtx, now=ctx.currentTime; const fStart=(kind==='grab')?130:110, fEnd=(kind==='grab')?85:70, dur=(kind==='grab')?0.7:0.5; const o1=ctx.createOscillator(), o2=ctx.createOscillator(); o1.type='sawtooth'; o2.type='triangle'; o1.frequency.setValueAtTime(fStart,now); o1.frequency.exponentialRampToValueAtTime(fEnd, now+dur); o2.frequency.setValueAtTime(fStart/2,now); o2.frequency.exponentialRampToValueAtTime(fEnd/2, now+dur); const bp1=ctx.createBiquadFilter(); bp1.type='bandpass'; bp1.Q.value=1.4; bp1.frequency.value=320; const bp2=ctx.createBiquadFilter(); bp2.type='bandpass'; bp2.Q.value=1.0; bp2.frequency.value=980; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1600; const mix=ctx.createGain(); mix.gain.value=.7; const env=ctx.createGain(); env.gain.setValueAtTime(.0001,now); env.gain.exponentialRampToValueAtTime(.6, now+.05); env.gain.exponentialRampToValueAtTime(.0001, now+dur); o1.connect(bp1); o1.connect(bp2); o2.connect(bp1); o2.connect(bp2); bp1.connect(mix); bp2.connect(mix); mix.connect(lp); lp.connect(env); env.connect(masterGain); o1.start(now); o2.start(now); o1.stop(now+dur+.05); o2.stop(now+dur+.05); }catch(_){} }
  
  // theremin
  function startTheremin(){
    const ok=ensureAudio();
    if(!audioCtx||audioCtx.state!=='running') return false;
    if(theremin) return true;
    const now=audioCtx.currentTime;
    const osc=audioCtx.createOscillator(); osc.type='sine';
    const vib=audioCtx.createOscillator(); vib.type='sine'; vib.frequency.value=5;
    const vibGain=audioCtx.createGain(); vibGain.gain.value=12; vib.connect(vibGain); vibGain.connect(osc.detune);
    const trem=audioCtx.createOscillator(); trem.type='sine'; trem.frequency.value=2;
    const tremDepth=audioCtx.createGain(); tremDepth.gain.value=.02; trem.connect(tremDepth);
    const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3200;
    const gain=audioCtx.createGain(); gain.gain.value=0.0001;

    // Ruteo: seco + envío a reverb GLOBAL
    const dry=audioCtx.createGain(); dry.gain.value=0.9;
    const send=audioCtx.createGain(); send.gain.value=0.18;

    osc.connect(lp); lp.connect(gain);
    tremDepth.connect(gain.gain);
    gain.connect(dry); dry.connect(masterGain);
    gain.connect(send); send.connect(reverbNode);

    osc.frequency.value=300; vib.start(now); trem.start(now); osc.start(now);
    theremin={osc,vib,vibGain,trem,tremDepth,gain,current:300};
    return true;
  }
  function thereminFadeIn(dur=2.0){ if(!theremin||!audioCtx) return; const now=audioCtx.currentTime; try{ theremin.gain.gain.cancelScheduledValues(now); theremin.gain.gain.setValueAtTime(0.0001, now); theremin.gain.gain.linearRampToValueAtTime(0.14, now + dur); }catch(_){} }
  function updateTheremin(dt){ if(!theremin||!audioCtx) return; const yNorm = clamp(currentY / VIEW_H, 0, 1); const minF=240, maxF=1040; const target = maxF - (maxF - minF) * yNorm; theremin.current += (target-theremin.current)*0.05; try{ theremin.osc.frequency.setTargetAtTime(theremin.current, audioCtx.currentTime, 0.025);}catch(_){} const vx=Math.abs(currentX-prevUfoX); const cents=8+Math.min(24,vx*3); try{ theremin.vibGain.gain.setTargetAtTime(cents, audioCtx.currentTime, 0.05);}catch(_){} }

  // ==== Rebaño
  let boxes=[], herdState=[];
  function buildHerd(count){ herdEl.innerHTML=''; boxes=[]; herdState=[]; for(let i=0;i<count;i++){ const el=document.createElement('div'); el.className='box cow'; el.innerHTML='<span class="head"></span><span class="ear left"></span><span class="ear right"></span><span class="leg left"></span><span class="leg right"></span><span class="tail"></span>'; herdEl.appendChild(el); boxes.push(el); herdState.push({x:0,y:0,w:30,h:20,vx:0,vy:0,prevX:0,prevY:0,captured:false,dropping:false,active:false,delivered:false,walking:false,hopT:0,gone:false}); } layoutBoxes(); }
  function layoutBoxes(){ const gap=8,w=30,h=20,n=boxes.length; const total = n>0 ? (n*w+(n-1)*gap):0; const startX = (SECTION_W/2)-total/2; const baseTop=horizonY()-h; boxes.forEach((el,i)=>{ const x=startX+i*(w+gap), y=baseTop; const s=herdState[i]; Object.assign(s,{w,h,x,y,vx:0,vy:0,prevX:x,prevY:y,captured:false,dropping:false,active:false,delivered:false,walking:false,hopT:0,gone:false}); el.style.left=x+'px'; el.style.top=y+'px'; }); }
  function isDelivered(s){ if (s.delivered) return true; const dropY=horizonY()-s.h; const cx=s.x+s.w/2; return (cx>=SECTION_PRADO_START+20) && !s.captured && !s.dropping && Math.abs(s.y-dropY)<0.5; }

  // ==== Decoración
  function populatePinar(){ pinarEl.innerHTML=''; const cnt=60,h=horizonY(); for(let i=0;i<cnt;i++){ const t=document.createElement('div'); t.className='tree shadow'; const w=18+Math.random()*34, he=w*(1.5+Math.random()*0.7); t.style.borderLeftWidth=(w/2)+'px'; t.style.borderRightWidth=(w/2)+'px'; t.style.borderBottomWidth=he+'px'; t.style.left=(Math.random()*(SECTION_W - w))+'px'; t.style.top=(h - he + 6)+'px'; pinarEl.appendChild(t);} }
  function populatePradoLeft(){ pradoEl.querySelectorAll('.tree').forEach(n=>n.remove()); const cnt=28,h=horizonY(), maxX=SECTION_W*0.42; for(let i=0;i<cnt;i++){ const t=document.createElement('div'); t.className='tree shadow'; const w=16+Math.random()*30, he=w*(1.6+Math.random()*0.6); t.style.borderLeftWidth=(w/2)+'px'; t.style.borderRightWidth=(w/2)+'px'; t.style.borderBottomWidth=he+'px'; t.style.left=(Math.random()*Math.max(0,maxX-w))+'px'; t.style.top=(h - he + 6)+'px'; pradoEl.appendChild(t);} }
  function buildStars(){ if(!starsEl) return; starsEl.innerHTML=''; const H=Math.max(20, Math.floor(VIEW_H*0.62)); const N=200; for(let i=0;i<N;i++){ const s=document.createElement('span'); s.className='star'; const size=(Math.random()<0.75)?2:3; const x=Math.random()*WORLD_W; const y=Math.random()*H; s.style.left=x+'px'; s.style.top=y+'px'; s.style.width=size+'px'; s.style.height=size+'px'; s.style.setProperty('--tw-dur', (2+Math.random()*3).toFixed(2)+'s'); s.style.animationDelay=(Math.random()*3).toFixed(2)+'s'; starsEl.appendChild(s);} }

  // ==== Camión
  function buildTruck(){ if (truckEl && truckEl.parentNode) truckEl.parentNode.removeChild(truckEl); truckEl=document.createElement('div'); truckEl.className='truck'; truckEl.innerHTML='<div class="body"></div><div class="cab"></div><div class="wheel w1"></div><div class="wheel w2"></div><div class="ramp"></div><div class="grill"></div>'; world.appendChild(truckEl); positionTruck(); }
  function positionTruck(){ if (!truckEl) return; const h=truckEl.offsetHeight||56; const y=horizonY()-h; truckEl.style.top=y+'px'; truckEl.style.left='6px'; }

  // ==== Interacción
  function computeScale(){ const vw=window.innerWidth||document.documentElement.clientWidth; const vh=window.innerHeight||document.documentElement.clientHeight; const s=Math.min(vw/VIEW_W, vh/VIEW_H); UISCALE=s; frame.style.transformOrigin='center center'; frame.style.transform=`scale(${s})`; }
  function setTargetFromPointer(clientX, clientY){ const r=frame.getBoundingClientRect(); const s=UISCALE||1; const lx=clamp((clientX-r.left)/s,0,VIEW_W); const ly=clamp((clientY-r.top)/s,0,VIEW_H); pointerLocalX=lx; pointerLocalY=ly; targetX=camX+lx; targetY=ly; idle=false; }
  function setActiveAtPoint(clientX, clientY){ const r=frame.getBoundingClientRect(); const s=UISCALE||1; const wx=camX + (clientX - r.left)/s; const y=(clientY - r.top)/s; let found=false; herdState.forEach((sCow,i)=>{ const inside = wx>=sCow.x && wx<=sCow.x+sCow.w && y>=sCow.y && y<=sCow.y+sCow.h; herdState[i].active = inside && !found; if(inside && !found) found=true; }); }
  function releaseCapture(){ if(capturedIndex!==-1){ const s=herdState[capturedIndex]; s.captured=false; s.dropping=true; capturedIndex=-1; } stopAbductTone(); }

  if (elIntro) {
    elIntro.addEventListener('pointerdown', (e)=>{ if(mode==='game' && phase==='ready'){ phase='running'; hideIntro(); e.stopPropagation(); e.preventDefault(); } }, {capture:true});
    elIntro.addEventListener('touchstart', (e)=>{ if(mode==='game' && phase==='ready'){ phase='running'; hideIntro(); e.stopPropagation(); e.preventDefault(); } }, {capture:true, passive:false});
  }
  frame.addEventListener('pointerdown', (e)=>{ if(mode!=='game' || paused) return; if(e.pointerType==='touch') return; if(phase==='ready'){ phase='running'; hideIntro(); } isPointerDown=true; beamOn=true; setTargetFromPointer(e.clientX,e.clientY); setActiveAtPoint(e.clientX,e.clientY); });
  frame.addEventListener('pointermove', (e)=>{ if(mode!=='game' || paused) return; if(e.pointerType==='touch') return; setTargetFromPointer(e.clientX,e.clientY); });
  frame.addEventListener('mousemove', (e)=>{ if(mode!=='game' || paused) return; setTargetFromPointer(e.clientX,e.clientY); });
  function endPress(){ if(isPointerDown){ isPointerDown=false; beamOn=false; releaseCapture(); } }
  frame.addEventListener('pointerup', endPress); frame.addEventListener('pointercancel', endPress); window.addEventListener('pointerup', endPress);
  // Touch: 1 dedo mueve, 2 dedos = haz
  frame.addEventListener('touchstart', (e)=>{ if(mode!=='game' || paused) return; if(phase==='ready'){ phase='running'; hideIntro(); } e.preventDefault(); const t=e.touches; if(t.length>0){ const p=t[0]; setTargetFromPointer(p.clientX,p.clientY); } isPointerDown=t.length>0; const wantBeam=t.length>=2; if(wantBeam && !beamOn){ beamOn=true; } if(!wantBeam && beamOn){ beamOn=false; releaseCapture(); } }, {passive:false});
  frame.addEventListener('touchmove', (e)=>{ if(mode!=='game' || paused) return; e.preventDefault(); const t=e.touches; if(t.length>0){ const p=t[0]; setTargetFromPointer(p.clientX,p.clientY); } const wantBeam=t.length>=2; if(wantBeam && !beamOn){ beamOn=true; } if(!wantBeam && beamOn){ beamOn=false; releaseCapture(); } }, {passive:false});
  frame.addEventListener('touchend', (e)=>{ if(mode!=='game') return; const t=e.touches; isPointerDown=t.length>0; const wantBeam=t.length>=2; if(!wantBeam && beamOn){ beamOn=false; releaseCapture(); } });

  // ==== HUD / Intro
  function composeIntroText(r, c){ if (r <= 1) { return { main: 'Salven las 4 vacas llevandolas al prado.', sub: 'Clic sobre las vacas para abducirlas.' }; } return { main: `Salven ${c} más por favor.`, sub: '' }; }
  function updateHUD(){ if(elTimer) elTimer.textContent=timeLeft.toFixed(1); if(elGoal) elGoal.textContent=`${deliveredCount}/${herdCount}`; if(elLevel) elLevel.textContent=`Lv ${Math.max(1, herdCount-3)}`; }
  function showIntro(){ if(!elIntro) return; elIntro.style.display='flex'; const panel=elIntro.querySelector('.panel'), hint=elIntro.querySelector('.hint'); [panel,introSub,hint].forEach(el=>{ if(!el) return; el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop'); }); }
  function hideIntro(){ if(elIntro) elIntro.style.display='none'; }
  function updateIntroText(){ const t=composeIntroText(round, herdCount); if(introMain) introMain.textContent=t.main; if(introSub){ introSub.textContent=t.sub||''; introSub.style.display=t.sub?'block':'none'; } }

  // ==== Rondas
  function startRound(resetCamera=true){
    mode='game'; phase='ready'; paused=false;
    deliveredCount=0; timeLeft=ROUND_TIME;
    capturedIndex=-1; beamOn=false; stopAbductTone();
    buildHerd(herdCount);
    if(resetCamera){ camX=0; camV=0; world.style.transform = `translate3d(${-camX}px,0,0)`; }
    pointerLocalX=VIEW_W/2; pointerLocalY=200;
    updateHUD(); updateIntroText(); showIntro();
  }
  function winRound(){ if(phase!=='running') return; phase='won'; herdCount+=1; round+=1; startRound(true); }
  function loseRound(){
    if(phase!=='running') return;
    phase='lost';
    stopAbductTone(true);
    playSadCue();
    mode='gameover'; gameOverStart=null; if(gameOverEl) gameOverEl.style.display='flex';
    herdCount=4; round=1; deliveredCount=0;
  }

  // ==== Audio UI + autoplay
  function showUnmute(){ if(unmuteBtn) unmuteBtn.style.display='block'; }
  function hideUnmute(){ if(unmuteBtn) unmuteBtn.style.display='none'; }
  function unlockAudio(){ const ok=ensureAudio(); const started=startTheremin(); if(started||theremin){ if(!thereminFaded){ thereminFadeIn(2.0); thereminFaded=true; } hideUnmute(); } }
  if(unmuteBtn) unmuteBtn.addEventListener('click', unlockAudio);
  document.addEventListener('keydown', ()=>{ if(!theremin) unlockAudio(); });
  document.addEventListener('pointerdown', ()=>{ if(!theremin) unlockAudio(); }, {capture:true});
  document.addEventListener('click', ()=>{ if(!theremin) unlockAudio(); }, {capture:true});
  document.addEventListener('touchstart', ()=>{ if(!theremin) unlockAudio(); }, {capture:true, passive:true});
  let autoTries=0; function attemptAutoplay(){ const ok=ensureAudio(); const started=startTheremin(); if(started||theremin){ if(!thereminFaded){ thereminFadeIn(2.0); thereminFaded=true; } hideUnmute(); return; } autoTries++; if(autoTries<12){ setTimeout(attemptAutoplay,250);} else { showUnmute(); } }

  // ==== Pausa (incluye audio)
  function audioFadeTo(target, dur=0.18){ if(!audioCtx||!masterGain) return; const now=audioCtx.currentTime; try{ masterGain.gain.cancelScheduledValues(now); masterGain.gain.setValueAtTime(Math.max(0.0001, masterGain.gain.value), now); masterGain.gain.linearRampToValueAtTime(target, now+dur);}catch(_){}}
  function setAudioPaused(flag){ if(!audioCtx) return; try{ if(flag){ stopAbductTone(true); audioFadeTo(0.0001,0.12); if(audioCtx.suspend) audioCtx.suspend(); } else { if(audioCtx.resume) audioCtx.resume(); audioFadeTo(0.35,0.18); } }catch(_){}}
  function togglePause(force){ paused=(typeof force==='boolean')?force:!paused; if(btnPause){ btnPause.setAttribute('aria-pressed', String(paused)); btnPause.textContent = paused ? '▶' : '⏸'; } setAudioPaused(paused); if(paused){ isPointerDown=false; beamOn=false; stopAbductTone(); } }
  if(btnPause) btnPause.addEventListener('click', ()=>togglePause());
  document.addEventListener('keydown', (e)=>{ if(e.key==='p'||e.key==='P'){ togglePause(); } });

  // ==== Animación principal
  function animate(ts){ try{
    if(ts==null) ts=performance.now(); if(lastTs==null) lastTs=ts; const dt=Math.max(0,(ts-lastTs)/1000); lastTs=ts;

    if(mode==='title'){
      if(titleStart===null) titleStart=ts; if(titleEl) titleEl.style.display='flex';
      const tt=clamp((ts-titleStart)/(TITLE_DUR*1000),0,1);
      if(tt>=1){ if(titleEl) titleEl.style.display='none'; mode='cinematic'; cineStart=null; }
      requestAnimationFrame(animate); return;
    }

    // Game Over → cartel + música, luego volver a cinemática
    if(mode==='gameover'){
      if(gameOverStart===null){ gameOverStart=ts; if(gameOverEl) gameOverEl.style.display='flex'; }
      const tg = clamp((ts - gameOverStart)/(GAMEOVER_DUR*1000), 0, 1);
      if(tg>=1){ if(gameOverEl) gameOverEl.style.display='none'; camX = MAX_CAM; camV = 0; world.style.transform = `translate3d(${-camX}px,0,0)`; capturedIndex=-1; beamOn=false; isPointerDown=false; stopAbductTone(true); mode='cinematic'; cineStart=null; }
      requestAnimationFrame(animate); return;
    }

    if(mode==='cinematic'){
      if(cineStart===null){ cineStart=ts; startTheremin(); if(theremin && !thereminFaded){ thereminFadeIn(2.0); thereminFaded=true; } }
      const t = clamp((ts - cineStart)/(CINE_DUR*1000), 0, 1);
      const ufoStartX = MAX_CAM + VIEW_W + 140; // entra por derecha del prado
      const ufoEndX = VIEW_W * 0.5;            // centro granja
      const p = linearThenSmoothDecel(t, 0.82);
      const cineX = ufoStartX + (ufoEndX - ufoStartX) * p;
      const cineY = 200 + Math.sin(t * Math.PI * 2) * 18; // bobbing
      currentX = cineX; currentY = cineY;
      const baseY = currentY - 30;
      ufo.style.left = (currentX - 60) + 'px';
      ufo.style.top  = baseY + 'px';
      const vxUfo = currentX - prevUfoX; prevUfoX = currentX; let desiredUfo = clamp(vxUfo * 0.5, -10, 10); ufoAngleDeg += (desiredUfo - ufoAngleDeg) * 0.2; ufo.style.transform='rotate('+ufoAngleDeg+'deg)';
      const camTarget = clamp(currentX - VIEW_W*0.5, 0, MAX_CAM); camX += (camTarget - camX) * 0.12; world.style.transform = `translate3d(${-camX}px,0,0)`;
      beamOn=false; beam.style.display='none'; stopAbductTone(); updateTheremin(dt);
      if(t>=1){ startRound(true); }
      requestAnimationFrame(animate); return;
    }

    // === Juego ===
    if (paused) { requestAnimationFrame(animate); return; }
    if(phase==='running'){ timeLeft-=dt; if(timeLeft<0) timeLeft=0; }

    // OVNI sigue al puntero
    targetX = camX + pointerLocalX; targetY = pointerLocalY;
    currentX += (targetX - currentX) * 0.12; currentY += (targetY - currentY) * 0.08;
    idle = (Math.abs(targetX-currentX)<0.2 && Math.abs(targetY-currentY)<0.2);
    const baseY = currentY - 30 + (idle ? Math.sin((idleAngle+=0.03))*5 : 0);
    ufo.style.left = (currentX - 60) + 'px'; ufo.style.top = baseY + 'px';

    // Tilt
    const vxUfo = currentX - prevUfoX; let desiredBeam = clamp(vxUfo * 0.7, -16, 16); if(!beamOn) desiredBeam=0; beamAngleDeg += (desiredBeam - beamAngleDeg) * 0.28; let desiredUfo = clamp(vxUfo * 0.5, -12, 12); ufoAngleDeg += (desiredUfo - ufoAngleDeg) * 0.25; ufo.style.transform='rotate('+ufoAngleDeg+'deg)'; prevUfoX=currentX;

    // Haz
    if(beamOn){
      const beamWidth=100; const coneTopX=currentX - beamWidth/2; const coneTopY=baseY + 60; const height=VIEW_H/2;
      beam.style.left=coneTopX+'px'; beam.style.top=coneTopY+'px'; beam.style.height=height+'px'; beam.style.display='block';
      if(!tone) startAbductTone();
    } else {
      beam.style.display='none';
      stopAbductTone();
    }
    beam.style.transform='rotate('+beamAngleDeg+'deg)';
    const beamRect = beamOn ? {left:currentX-50,right:currentX+50,top:baseY+60,bottom:baseY+60+(VIEW_H/2)} : null;

    // Captura exclusiva
    if(beamOn && capturedIndex===-1 && beamRect){ let candidate=-1, bestDx=Infinity; boxes.forEach((el,i)=>{ const s=herdState[i]; if(s.gone) return; const overlaps=(s.x+s.w)>beamRect.left && s.x<beamRect.right && (s.y+s.h)>beamRect.top && s.y<beamRect.bottom; if(overlaps){ const dx=Math.abs((s.x+s.w/2)-currentX); if(dx<bestDx){bestDx=dx; candidate=i;} } }); if(candidate!==-1){ capturedIndex=candidate; const s=herdState[capturedIndex]; s.captured=true; s.dropping=false; playMoo('grab'); } }

    // Física vacas
    const g=Math.max(.22, VIEW_H*0.0012), air=.96, clearance=24;
    boxes.forEach((el,i)=>{
      const s=herdState[i]; if(s.gone) return; const px=s.x, py=s.y;
      if(i===capturedIndex && beamOn){ const ty=baseY+60 - s.h - 4 + clearance; const tx=currentX - s.w/2; s.x += (tx - s.x)*0.30; s.y += (ty - s.y)*0.02; s.vx = s.x - px; s.vy = s.y - py; }
      else if(s.dropping){ s.vy += g; s.x += s.vx; s.y += s.vy; s.vx *= air; const minX=0, maxX=WORLD_W - s.w; if(s.x<minX){ s.x=minX; s.vx=-s.vx*0.4; } if(s.x>maxX){ s.x=maxX; s.vx=-s.vx*0.4; } const dropY=horizonY()-s.h; if(s.y>=dropY){ s.y=dropY; s.vx*=0.5; s.vy=0; s.dropping=false; playMoo('land'); const cx = s.x + s.w/2; if (cx >= SECTION_PRADO_START+20){ s.delivered = true; s.walking = true; s.hopT = 0; s.vx = 0.9 + Math.random()*0.6; } } }
      else if(s.walking){
        const dropY = horizonY() - s.h;
        // saltitos continuos, un poquito más altos y con algo más de hang time
        s.hopT -= dt;
        if (s.hopT <= 0 && Math.abs(s.y - dropY) < 0.01) {
          s.vy = -(3.2 + Math.random()*1.1);   // impulso del salto
          s.hopT = 0.38 + Math.random()*0.26; // cadencia
        }
        s.vx = Math.max(1.05, s.vx || 1.05);
        const gw = g * 0.52; // más hang time
        s.vy += gw;
        if (s.vy < 0) s.vy *= 0.988;
        s.x += s.vx; s.y += s.vy;
        if (s.y >= dropY) { s.y = dropY; if (s.vy > 0) s.vy = 0; }
        if (s.x > WORLD_W + s.w) { s.gone = true; el.style.display = 'none'; }
      }
      else { const dropY=horizonY()-s.h; if(s.y!==dropY) s.y=dropY; s.vx=0; s.vy=0; }
      el.style.left=s.x+'px'; el.style.top=s.y+'px';
    });

    // Progreso / HUD
    deliveredCount = herdState.reduce((a,s)=> a + (isDelivered(s)?1:0), 0);
    updateHUD();
    if(phase==='running'){ if(deliveredCount>=herdCount) winRound(); else if(timeLeft<=0) loseRound(); }

    // Scroll por posición (zonas muertas en extremos)
    { const lx=pointerLocalX; let leftDead=VIEW_W*.25, rightDead=VIEW_W*.75, band=VIEW_W*.25; if(camX===0){ leftDead=VIEW_W*.75; rightDead=VIEW_W*.75; band=VIEW_W*.25; } if(camX===MAX_CAM){ leftDead=VIEW_W*.25; rightDead=VIEW_W*.25; band=VIEW_W*.25; } let desired=0, SCROLL_MAX=32, SCROLL_RESP=.12, SCROLL_FRICTION=.90; if(camX<MAX_CAM && lx>rightDead){ const t=Math.min(1,(lx-rightDead)/band); desired= t*SCROLL_MAX; } else if(camX>0 && lx<leftDead){ const t=Math.min(1,(leftDead-lx)/band); desired=-t*SCROLL_MAX; } camV += (desired - camV) * SCROLL_RESP; if(desired===0){ camV *= SCROLL_FRICTION; if(Math.abs(camV)<.02) camV=0; } }
    camX += camV; if(camX<0){camX=0;camV=0;} if(camX>MAX_CAM){camX=MAX_CAM;camV=0;} world.style.transform=`translate3d(${-camX}px,0,0)`;

    updateTheremin(dt);

    requestAnimationFrame(animate);
  }catch(e){ console.error(e); requestAnimationFrame(animate); }}

  // ==== Inicio
  function init(){
    computeScale();
    buildStars();
    populatePinar();
    populatePradoLeft();
    buildTruck();
    positionTruck();
    // arrancamos mirando el PRADO para la cinemática
    world.style.transform = `translate3d(${-MAX_CAM}px,0,0)`;
    attemptAutoplay();
    requestAnimationFrame(animate);
  }

  // Re-layout en cambios de tamaño/orientación
  window.addEventListener('resize', ()=>{
    computeScale();
    layoutBoxes();
    buildStars();
    populatePinar();
    populatePradoLeft();
    positionTruck();
  });
  window.addEventListener('orientationchange', ()=>{
    setTimeout(()=>{
      computeScale();
      layoutBoxes();
      buildStars();
      populatePinar();
      populatePradoLeft();
      positionTruck();
    }, 60);
  });

  document.addEventListener('DOMContentLoaded', init, {once:true});
  </script>
</body>
</html>
